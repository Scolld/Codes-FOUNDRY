<form class="quest-form-content" autocomplete="off">
  <!-- Onglets -->
  <nav class="tabs">
    <a class="item active" data-tab="basic">
      <i class="fas fa-info-circle"></i> Informations
    </a>
    <a class="item" data-tab="relations">
      <i class="fas fa-link"></i> Relations
    </a>
    <a class="item" data-tab="rewards">
      <i class="fas fa-gift"></i> Récompenses
    </a>
    <a class="item" data-tab="details">
      <i class="fas fa-file-alt"></i> Détails
    </a>
    {{#if isGM}}
      <a class="item" data-tab="gm">
        <i class="fas fa-crown"></i> MJ
      </a>
    {{/if}}
  </nav>

  <!-- Contenu des onglets -->
  <section class="tab-content">
    <!-- Onglet: Informations de base -->
    <div class="tab" data-tab="basic">
      <div class="form-group">
        <label for="title">
          Titre <span class="required">*</span>
        </label>
        <input 
          type="text" 
          name="title" 
          id="title" 
          value="{{quest.title}}" 
          placeholder="Nom de la quête"
          maxlength="200"
          required
        >
        <p class="hint">Maximum 200 caractères</p>
      </div>

      <div class="form-group">
        <label for="status">Statut</label>
        <select name="status" id="status">
          {{#each statuses}}
            <option value="{{value}}" {{#if (eq value ../quest.status)}}selected{{/if}}>
              {{label}}
            </option>
          {{/each}}
        </select>
      </div>

      <div class="form-group">
        <label for="description">
          Description
          <span class="editor-hint">(Utilisez @ pour créer des liens vers acteurs, items, etc.)</span>
        </label>
        <textarea 
          name="description" 
          id="description" 
          class="editor"
          rows="10"
          placeholder="Décrivez la quête..."
        >{{quest.description}}</textarea>
        <p class="hint">Supporte les liens Foundry: @Actor[id]{nom}, @Item[id]{nom}, @JournalEntry[id]{nom}</p>
      </div>
    </div>

    <!-- Onglet: Relations -->
    <div class="tab" data-tab="relations">
      <div class="form-group">
        <label for="parentId">
          <i class="fas fa-level-up-alt"></i> Quête parente
        </label>
        <select name="parentId" id="parentId">
          <option value="">-- Aucune (quête racine) --</option>
          {{#each availableParents}}
            <option value="{{id}}" {{#if selected}}selected{{/if}}>
              {{title}}
            </option>
          {{/each}}
        </select>
        <p class="hint">Cette quête sera une sous-quête de la quête sélectionnée</p>
      </div>

      <div class="form-group">
        <label>
          <i class="fas fa-lock"></i> Bloquée par
        </label>
        <div class="relation-manager">
          <div class="relation-input">
            <select id="blockedBy-select" class="relation-select">
              <option value="">-- Sélectionner une quête --</option>
              {{#each availableQuests}}
                <option value="{{id}}">{{title}}</option>
              {{/each}}
            </select>
            <button type="button" id="add-blocked-by" class="add-relation-btn">
              <i class="fas fa-plus"></i> Ajouter
            </button>
          </div>
          <ul id="blockedBy-list" class="relation-list">
            {{#each blockedByQuests}}
              <li class="relation-item" data-quest-id="{{id}}">
                <span>{{title}}</span>
                <button type="button" class="remove-relation" data-relation-type="blockedBy" data-quest-id="{{id}}">
                  <i class="fas fa-times"></i>
                </button>
              </li>
            {{/each}}
          </ul>
        </div>
        <p class="hint">Cette quête ne peut pas être commencée tant que les quêtes listées ne sont pas terminées</p>
      </div>

      <div class="form-group">
        <label>
          <i class="fas fa-ban"></i> Bloque
        </label>
        <div class="relation-manager">
          <div class="relation-input">
            <select id="blocks-select" class="relation-select">
              <option value="">-- Sélectionner une quête --</option>
              {{#each availableQuests}}
                <option value="{{id}}">{{title}}</option>
              {{/each}}
            </select>
            <button type="button" id="add-blocks" class="add-relation-btn">
              <i class="fas fa-plus"></i> Ajouter
            </button>
          </div>
          <ul id="blocks-list" class="relation-list">
            {{#each blocksQuests}}
              <li class="relation-item" data-quest-id="{{id}}">
                <span>{{title}}</span>
                <button type="button" class="remove-relation" data-relation-type="blocks" data-quest-id="{{id}}">
                  <i class="fas fa-times"></i>
                </button>
              </li>
            {{/each}}
          </ul>
        </div>
        <p class="hint">Cette quête doit être terminée avant que les quêtes listées puissent être commencées</p>
      </div>

      <div class="form-group">
        <label>
          <i class="fas fa-link"></i> Liée à
        </label>
        <div class="relation-manager">
          <div class="relation-input">
            <select id="related-select" class="relation-select">
              <option value="">-- Sélectionner une quête --</option>
              {{#each availableQuests}}
                <option value="{{id}}">{{title}}</option>
              {{/each}}
            </select>
            <button type="button" id="add-related" class="add-relation-btn">
              <i class="fas fa-plus"></i> Ajouter
            </button>
          </div>
          <ul id="related-list" class="relation-list">
            {{#each relatedQuests}}
              <li class="relation-item" data-quest-id="{{id}}">
                <span>{{title}}</span>
                <button type="button" class="remove-relation" data-relation-type="related" data-quest-id="{{id}}">
                  <i class="fas fa-times"></i>
                </button>
              </li>
            {{/each}}
          </ul>
        </div>
        <p class="hint">Quêtes liées par contexte ou histoire (sans dépendance)</p>
      </div>
    </div>

    <!-- Onglet: Récompenses -->
    <div class="tab" data-tab="rewards">
      <div class="form-group">
        <label>
          <i class="fas fa-gift"></i> Récompenses (Texte libre)
        </label>
        <textarea 
          name="rewards" 
          id="rewards" 
          class="editor"
          rows="4"
          placeholder="Description textuelle des récompenses..."
        >{{quest.rewards}}</textarea>
        <p class="hint">Supporte les liens Foundry pour les items: @Item[id]{nom}</p>
      </div>

      <div class="form-group">
        <label>
          <i class="fas fa-treasure-chest"></i> Items de récompense
        </label>
        
        <div class="reward-item-drop-zone">
          <div class="drop-zone-hint">
            <i class="fas fa-hand-holding-box"></i>
            <p>Glissez-déposez des items ici ou cliquez sur "Ajouter un item"</p>
          </div>
        </div>
        
        <ul id="reward-items-list" class="reward-items-list">
          {{#each rewardItemsList}}
            <li class="reward-item" data-item-uuid="{{itemUuid}}">
              <img src="{{itemImg}}" alt="{{itemName}}" />
              <div class="reward-item-info">
                <strong>{{itemName}}</strong>
                <span>Quantité: {{quantity}}</span>
              </div>
              <button type="button" class="remove-reward-item" title="Supprimer">
                <i class="fas fa-times"></i>
              </button>
            </li>
          {{/each}}
        </ul>
        
        <button type="button" id="add-reward-item" class="action-btn">
          <i class="fas fa-plus"></i> Ajouter un item
        </button>
      </div>

      <div class="form-group">
        <label>
          <i class="fas fa-user-check"></i> Complétée par
        </label>
        <select name="completedBy" id="completedBy">
          <option value="">-- Aucun --</option>
          {{#each availableActors}}
            <option value="{{id}}" {{#if selected}}selected{{/if}}>
              {{name}}
            </option>
          {{/each}}
        </select>
        <p class="hint">Sélectionnez l'acteur qui a terminé cette quête pour distribuer les récompenses</p>
      </div>

      {{#if completionInfo}}
        <div class="completion-info">
          <h4><i class="fas fa-check-circle"></i> Informations de complétion</h4>
          
          <div class="completion-details">
            <div class="completion-actor">
              <img src="{{completionInfo.actorImg}}" alt="{{completionInfo.actorName}}" />
              <div>
                <strong>{{completionInfo.actorName}}</strong>
                {{#if completionInfo.completedAt}}
                  <span>Complétée le {{completionInfo.completedAt}}</span>
                {{/if}}
              </div>
            </div>
            
            {{#if completionInfo.rewardsDistributed}}
              <div class="rewards-status distributed">
                <i class="fas fa-check-double"></i>
                <span>Récompenses distribuées</span>
              </div>
            {{else}}
              {{#if rewardItemsList.length}}
                <button type="button" id="distribute-rewards" class="action-btn success">
                  <i class="fas fa-hand-holding-heart"></i> Distribuer les récompenses
                </button>
              {{else}}
                <div class="rewards-status no-rewards">
                  <i class="fas fa-info-circle"></i>
                  <span>Aucune récompense item à distribuer</span>
                </div>
              {{/if}}
            {{/if}}
          </div>
        </div>
      {{/if}}
    </div>

    <!-- Onglet: Détails -->
    <div class="tab" data-tab="details">
      <div class="form-group">
        <label for="rewards">
          <i class="fas fa-gift"></i> Récompenses
        </label>
        <textarea 
          name="rewards" 
          id="rewards" 
          class="editor"
          rows="4"
          placeholder="Récompenses obtenues à la fin de la quête..."
        >{{quest.rewards}}</textarea>
        <p class="hint">Supporte les liens Foundry pour les items: @Item[id]{nom}</p>
      </div>

      <div class="form-group">
        <label for="location">
          <i class="fas fa-map-marker-alt"></i> Lieu
        </label>
        <input 
          type="text" 
          name="location" 
          id="location" 
          value="{{quest.location}}" 
          placeholder="@JournalEntry[id]{Nom du lieu}"
        >
        <p class="hint">Utilisez @JournalEntry pour lier un lieu de votre journal</p>
      </div>

      <div class="form-group">
        <label for="npcs">
          <i class="fas fa-users"></i> PNJs impliqués
        </label>
        <textarea 
          name="npcs" 
          id="npcs" 
          rows="4"
          placeholder="@Actor[id]{Nom du PNJ}&#10;@Actor[id2]{Autre PNJ}&#10;Un par ligne..."
        >{{npcsList}}</textarea>
        <p class="hint">Un PNJ par ligne. Utilisez @Actor pour lier des acteurs</p>
      </div>
    </div>

    <!-- Onglet: Notes MJ (visible uniquement par le GM) -->
    {{#if isGM}}
      <div class="tab" data-tab="gm">
        <div class="form-group">
          <label for="notes">
            <i class="fas fa-sticky-note"></i> Notes privées (MJ uniquement)
          </label>
          <textarea 
            name="notes" 
            id="notes" 
            rows="10"
            placeholder="Notes visibles uniquement par le MJ..."
          >{{quest.notes}}</textarea>
          <p class="hint">Ces notes ne sont visibles que par le MJ</p>
        </div>
      </div>
    {{/if}}
  </section>

  <!-- Boutons de validation -->
  <footer class="form-footer">
    <button type="button" class="cancel-btn" data-action="close">
      <i class="fas fa-times"></i> Annuler
    </button>
    <button type="submit" class="submit-btn">
      <i class="fas fa-save"></i> 
      {{#if isEdit}}Enregistrer{{else}}Créer{{/if}}
    </button>
  </footer>
</form>